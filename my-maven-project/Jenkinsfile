pipeline {
  agent any

  tools {
    maven 'M3'  // This refers to the Maven tool installed on Jenkins (make sure 'M3' is configured in Jenkins tools)
  }

  stages {
    stage('Checkout Code') {
      steps {
        git branch: 'main', url: 'https://github.com/akhil2099/maven-demo.git'
      }
    }

    stage('Build') {
      steps {
        script {
          // Navigate to the directory containing pom.xml
          dir('maven-demo/my-maven-project') {
            // Use Maven to clean and package the project, skipping tests
            sh 'mvn -B -DskipTests clean package'
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        script {
          withCredentials([string(credentialsId: 'SonarQube', variable: 'SONAR_TOKEN')]) {
            // Navigate to the correct directory for SonarQube analysis
            dir('maven-demo/my-maven-project') {
              // Run SonarQube analysis with the token
              sh """
                mvn clean verify sonar:sonar \
                -Dsonar.projectKey=maven-demo \
                -Dsonar.login=${SONAR_TOKEN} \
                -Dsonar.host.url=http://localhost:9000
              """
            }
          }
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {  // Increased timeout
          script {
            def qualityGate = waitForQualityGate()
            if (qualityGate.status != 'OK') {
              error "Quality Gate failed: ${qualityGate.status}"
            }
          }
        }
      }
    }
  }

  post {
    success {
      echo 'Pipeline completed successfully!'
    }
    failure {
      echo 'Pipeline failed. Check the logs for more details.'
    }
  }
}

